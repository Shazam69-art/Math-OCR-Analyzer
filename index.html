<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math.AI Analyzer - CAS Educations</title>

  <!--
    UI NOTE (interface only):
    Put your logo here so it never breaks:
      ./assets/cas-logo.png

    Folder structure:
      index.html
      assets/
        cas-logo.png

    If you don't want an assets folder, change both <img src="./assets/cas-logo.png"> to your real filename.
  -->

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      },
      startup: { pageReady: () => MathJax.startup.defaultPageReady() }
    };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      /* CAS brand */
      --cas-950:#021725;
      --cas-900:#04314d;
      --cas-850:#053a5a;
      --cas-800:#064469; /* main */
      --cas-700:#0a5a87;
      --cas-650:#0d659a;
      --cas-600:#0f6fa6;
      --cas-150:#d7ebfb;
      --cas-100:#eaf3fb;

      /* App tokens */
      --background:#f8fbff;
      --foreground:#0d1726;
      --muted:#eef4fa;
      --muted-foreground:#5a6b7c;
      --card:rgba(255,255,255,.78);
      --card-solid:#ffffff;
      --border:rgba(9, 61, 94, .12);
      --ring:rgba(15,111,166,.45);

      --primary:var(--cas-800);
      --primary-2:var(--cas-600);
      --primary-foreground:#ffffff;

      --radius:18px;
      --shadow: 0 22px 60px rgba(3, 38, 60, .16);
      --shadow-soft: 0 12px 28px rgba(3, 38, 60, .12);
    }

    html, body { height: 100%; }

    /* ======= GLOBAL BACKGROUND (more “fancy”, NOT white) ======= */
    body{
      font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      color: var(--foreground);
      background:
        radial-gradient(1200px circle at 12% 18%, rgba(15,111,166,.36), transparent 58%),
        radial-gradient(1000px circle at 88% 18%, rgba(6,68,105,.34), transparent 60%),
        radial-gradient(1200px circle at 50% 110%, rgba(10,90,135,.26), transparent 60%),
        linear-gradient(180deg, #031b2a 0%, #052a42 35%, #073b5c 70%, #032133 100%);
      overflow: hidden;
      position: relative;
    }

    /* subtle animated glow */
    .bg-orbs{
      position: fixed; inset: 0; pointer-events:none; z-index: 0;
      filter: blur(46px);
      opacity: .65;
    }
    .orb{
      position:absolute; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(15,111,166,.75), rgba(6,68,105,.38), transparent 70%);
      animation: floaty 10s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    .orb.one{ width: 620px; height: 620px; left:-190px; top:-170px; animation-duration: 12s; }
    .orb.two{ width: 540px; height: 540px; right:-220px; top:30px; animation-duration: 14s; }
    .orb.three{ width: 680px; height: 680px; left:18%; bottom:-360px; animation-duration: 16s; opacity:.50; }

    @keyframes floaty{
      0%,100% { transform: translate3d(0,0,0) scale(1); }
      50% { transform: translate3d(0,-22px,0) scale(1.04); }
    }

    /* “Premium texture” overlay on whole page */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(circle at 80% 15%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          transparent 1px,
          transparent 11px
        );
      opacity: .18;
      mix-blend-mode: overlay;
    }

    /* Buttons */
    .btn, button {
      border: 0;
      cursor: pointer;
      font-weight: 700;
      border-radius: 14px;
      padding: 12px 16px;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease, background .12s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      user-select: none;
    }
    .btn:active, button:active { transform: translateY(1px); }
    .btn-primary{
      color: var(--primary-foreground);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
      box-shadow: 0 16px 30px rgba(6,68,105,.26);
    }
    .btn-primary:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(6,68,105,.30);
    }
    .btn-outline{
      background: rgba(255,255,255,.72);
      border: 1px solid var(--border);
      color: var(--foreground);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn-outline:hover{ background: rgba(255,255,255,.86); }
    .btn-ghost{
      background: transparent;
      border: 1px solid transparent;
      color: var(--foreground);
    }
    .btn-ghost:hover{ background: rgba(6,68,105,.06); border-color: rgba(6,68,105,.10); }

    .loading{
      width: 18px; height: 18px;
      border: 3px solid rgba(255,255,255,.45);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Inputs */
    input, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(9, 61, 94, .16);
      background: rgba(255,255,255,.86);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      font-family: inherit;
      font-size: 14px;
    }
    input:focus, textarea:focus{
      border-color: rgba(15,111,166,.45);
      background: rgba(255,255,255,.94);
      box-shadow: 0 0 0 4px var(--ring);
    }
    label{
      font-size: 12px;
      font-weight: 800;
      color: rgba(13,23,38,.78);
      letter-spacing: .02em;
      margin-bottom: 8px;
      display: block;
    }
    .helper{ font-size: 12px; color: var(--muted-foreground); }

    /* Layout */
    .dashboard-container{
      position: relative;
      z-index: 1;
      height: 100vh;
      width: 100%;
      transition: filter .25s ease, transform .25s ease, opacity .25s ease;
    }
    .dashboard-layout{ display:flex; height:100%; width:100%; }

    /* Sidebar (glass) */
    .sidebar{
      width: 18rem;
      background: rgba(255,255,255,.62);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:flex; flex-direction:column;
    }
    .sidebar-header{
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border);
    }
    .brand-lockup{
      display:flex; align-items:center; gap: 12px;
      cursor: pointer;
    }
    .brand-mark{
      width: 44px; height: 44px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(6,68,105,.95) 0%, rgba(15,111,166,.95) 100%);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 18px 32px rgba(6,68,105,.26);
      color:#fff;
      font-weight: 900;
    }
    .brand-texts{ display:flex; flex-direction:column; line-height: 1.1; }
    .brand-title{ font-size: 14px; font-weight: 900; letter-spacing: .02em; }
    .brand-subtitle{ font-size: 12px; color: rgba(13,23,38,.62); font-weight: 700; }

    .sidebar-content{ flex:1; overflow-y:auto; padding: 16px; }
    .sidebar-section-title{
      font-size: 11px;
      font-weight: 900;
      color: rgba(13,23,38,.55);
      text-transform: uppercase;
      letter-spacing: .08em;
      padding: 0 10px;
      margin: 8px 0 10px;
    }
    .sidebar-item{
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: background .15s ease, transform .15s ease;
      border: 1px solid rgba(9,61,94,.10);
      background: rgba(255,255,255,.35);
      margin-bottom: 10px;
    }
    .sidebar-item:hover{
      background: rgba(255,255,255,.70);
      transform: translateY(-1px);
    }
    .sidebar-item-title{
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-item-date{
      font-size: 12px;
      color: rgba(13,23,38,.55);
      font-weight: 700;
    }

    /* Main area */
    .main-content{ flex:1; display:flex; flex-direction:column; overflow:hidden; }
    .header{
      background: rgba(255,255,255,.78);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 14px 18px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow: 0 10px 25px rgba(3,38,60,.08);
    }
    .header-left{ display:flex; align-items:center; gap: 12px; }
    .header-logo{
      display:flex; align-items:center; gap: 14px;
      cursor:pointer;
    }
    .cas-logo{
      height: 34px;
      max-width: 240px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(6,68,105,.18));
    }
    .header-brand-wrap{ display:flex; flex-direction:column; line-height: 1.1; }
    .header-brand{ font-weight: 900; font-size: 14px; letter-spacing: .02em; }
    .header-brand-sub{ font-size: 12px; color: rgba(13,23,38,.58); font-weight: 800; }

    .header-right{ display:flex; align-items:center; gap: 12px; }
    .user-info{
      font-size: 13px;
      font-weight: 800;
      color: rgba(13,23,38,.70);
    }
    .user-name{ color: var(--primary); }

    .content-area{ flex:1; overflow-y:auto; padding: 22px; }

    /* Cards */
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    /* Upload section */
    .upload-section, .results-section{ max-width: 1100px; margin: 0 auto; width: 100%; }
    .section-header{ margin: 8px 0 22px; }
    .section-header h1{
      font-size: 34px;
      letter-spacing: -0.02em;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .section-header p{ font-size: 15px; color: var(--muted-foreground); font-weight: 700; }

    .upload-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }
    .upload-card{
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid rgba(6,68,105,.16);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-soft);
      cursor:pointer;
      transition: transform .14s ease, border-color .14s ease, background .14s ease, box-shadow .14s ease;
      position: relative;
      overflow: hidden;
    }
    .upload-card::after{
      content:"";
      position:absolute; inset:-120px -120px auto auto;
      width: 260px; height: 260px;
      background: radial-gradient(circle at 30% 30%, rgba(15,111,166,.25), transparent 70%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .upload-card:hover{
      transform: translateY(-2px);
      border-color: rgba(15,111,166,.55);
      background: rgba(255,255,255,.82);
      box-shadow: 0 18px 40px rgba(3,38,60,.14);
    }
    .upload-icon{
      width: 56px; height: 56px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(6,68,105,.10), rgba(15,111,166,.12));
      border: 1px solid rgba(6,68,105,.14);
      display:flex; align-items:center; justify-content:center;
      margin-bottom: 12px;
    }
    .upload-icon svg{ width: 26px; height: 26px; color: var(--primary); }
    .upload-card h3{ font-size: 15px; font-weight: 900; margin-bottom: 6px; }
    .upload-card p{ font-size: 13px; color: rgba(13,23,38,.62); font-weight: 700; margin-bottom: 12px; }
    .file-list{ margin-top: 10px; }
    .file-item{
      display:flex; align-items:center; gap: 8px;
      font-size: 12px;
      color: rgba(13,23,38,.66);
      font-weight: 700;
      margin-bottom: 6px;
    }
    .file-item svg{ width: 14px; height: 14px; color: rgba(15,111,166,.85); }

    .btn-start{
      min-width: 240px;
      padding: 12px 18px;
      font-size: 14px;
    }
    .btn-start:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    /* Results */
    .results-header{
      display:flex; align-items:flex-start; justify-content:space-between;
      margin: 6px 0 16px;
      gap: 12px; flex-wrap: wrap;
    }
    .results-header h1{ font-size: 26px; font-weight: 900; }
    .results-header p{ color: var(--muted-foreground); font-weight: 700; font-size: 13px; margin-top: 4px; }

    .badge-group{ display:flex; gap: 10px; flex-wrap: wrap; }
    .badge{
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--border);
      display:inline-flex; align-items:center; gap: 10px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .badge-dot{ width: 10px; height: 10px; border-radius: 999px; }
    .badge-dot.correct{ background:#22c55e; }
    .badge-dot.partial{ background:#eab308; }
    .badge-dot.incorrect{ background:#ef4444; }

    /* Accordion */
    .accordion{ display:flex; flex-direction:column; gap: 12px; }
    .accordion-item{
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.68);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .accordion-trigger{
      width: 100%;
      padding: 16px;
      display:flex;
      gap: 12px;
      cursor:pointer;
      background: transparent;
      border: 0;
      text-align:left;
      transition: background .12s ease;
    }
    .accordion-trigger:hover{ background: rgba(6,68,105,.05); }
    .question-number{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      flex-shrink: 0;
      border: 1px solid rgba(13,23,38,.08);
    }
    .question-number.correct{ background: rgba(34,197,94,.12); color:#16a34a; }
    .question-number.partial{ background: rgba(234,179,8,.12); color:#ca8a04; }
    .question-number.incorrect{ background: rgba(239,68,68,.12); color:#dc2626; }
    .question-info{ flex:1; padding-top: 2px; }
    .question-info p:first-child{ font-weight: 900; margin-bottom: 4px; }
    .question-info p:last-child{ font-size: 12px; color: rgba(13,23,38,.62); font-weight: 800; text-transform: capitalize; }

    .accordion-content{ display:none; padding: 0 16px 16px; }
    .accordion-content.open{ display:block; }

    .analysis-section{ margin-top: 14px; }
    .analysis-section h3{
      font-weight: 900;
      font-size: 14px;
      margin-bottom: 10px;
      display:flex; align-items:center; gap: 10px;
      color: rgba(13,23,38,.86);
    }
    .analysis-section h3 svg{ width: 18px; height: 18px; color: rgba(15,111,166,.95); }

    .solution-card{
      border-radius: 16px;
      padding: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
    }
    .solution-card.error{ background: rgba(239,68,68,.06); border-color: rgba(239,68,68,.25); }
    .solution-card.corrected{ background: rgba(34,197,94,.06); border-color: rgba(34,197,94,.25); }
    .solution-steps{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }
    .solution-steps p{ margin-bottom: 10px; line-height: 1.8; }

    .reanalysis-card{
      margin-top: 14px;
      border-radius: 18px;
      background: rgba(234,243,251,.75);
      border: 1px solid rgba(6,68,105,.16);
      padding: 14px;
    }
    .reanalysis-input-group{ display:flex; gap: 10px; }
    .ai-response{
      margin-top: 12px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display:flex; align-items:flex-start; gap: 10px;
    }
    .ai-badge{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#fff;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      flex-shrink:0;
      margin-top: 2px;
    }
    .ai-response p{ font-size: 13px; font-weight: 700; color: rgba(13,23,38,.82); line-height: 1.7; }

    /* Practice paper */
    .practice-paper-card{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(6,68,105,.16);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 18px;
    }
    .practice-paper-card h3{ font-size: 16px; font-weight: 900; margin-bottom: 6px; }
    .practice-paper-card p{ color: rgba(13,23,38,.62); font-weight: 700; font-size: 13px; margin-bottom: 12px; }
    .practice-paper{ padding: 26px; background: #fff; border-radius: 18px; border: 1px solid rgba(6,68,105,.12); }
    .practice-header{ margin-bottom: 22px; text-align:center; }
    .practice-title{ font-size: 22px; font-weight: 900; margin-bottom: 6px; color: var(--cas-800); }
    .practice-subtitle{ font-size: 13px; color: rgba(13,23,38,.62); font-weight: 700; }
    .practice-question{ margin-bottom: 18px; }
    .practice-question-number{ font-size: 14px; font-weight: 900; color: var(--cas-700); margin-bottom: 8px; }
    .practice-question-text{ font-weight: 700; }

    /* Modals */
    .modal{
      display:none;
      position: fixed; inset:0;
      background: rgba(4, 28, 44, .55);
      z-index: 60;
      align-items:center; justify-content:center;
      padding: 16px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modal.open{ display:flex; }
    .modal-content{
      width: 100%;
      max-width: 860px;
      border-radius: 22px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: 0 24px 80px rgba(2, 22, 34, .28);
      overflow:hidden;
    }
    .modal-header{
      padding: 16px 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(6,68,105,.12);
      background: rgba(255,255,255,.65);
    }
    .modal-header h3{ font-size: 15px; font-weight: 900; }
    .modal-body{ padding: 16px 18px; }
    .modal-image{
      position: relative;
      aspect-ratio: 3 / 4;
      background: rgba(238,244,250,.85);
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(6,68,105,.12);
    }
    .modal-image img{ width:100%; height:100%; object-fit: cover; }
    .error-highlight{
      position:absolute;
      border: 4px solid #ef4444;
      border-radius: 12px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.5} }
    .modal-caption{ text-align:center; font-size: 12px; font-weight: 800; color: rgba(13,23,38,.62); margin-top: 10px; padding-bottom: 6px; }

    /* =========================
       AUTH PAGE (overlay but looks like its own page)
       ========================= */

    .auth-overlay{
      position: fixed; inset: 0;
      display:none;
      z-index: 80;

      /* Strong, non-white background */
      background:
        radial-gradient(1200px circle at 18% 18%, rgba(15,111,166,.55), transparent 60%),
        radial-gradient(1000px circle at 86% 22%, rgba(6,68,105,.55), transparent 62%),
        radial-gradient(1100px circle at 50% 120%, rgba(10,90,135,.45), transparent 62%),
        linear-gradient(180deg, #021624 0%, #04314d 40%, #021725 100%);
      align-items:center;
      justify-content:center;
      padding: 18px;

      overflow: hidden;
    }
    .auth-overlay.open{ display:flex; }

    /* Extra texture + motion in the auth page background */
    .auth-overlay::before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(circle at 80% 25%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          transparent 1px,
          transparent 12px
        );
      opacity: .22;
      mix-blend-mode: overlay;
      filter: blur(0px);
      animation: authBgDrift 16s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes authBgDrift{
      0%,100% { transform: translate3d(-2%, -1%, 0) rotate(0deg); }
      50%     { transform: translate3d(2%,  1%, 0) rotate(1.2deg); }
    }

    /* Make it feel like a separate page (blur/scale dashboard behind) — CSS ONLY */
    .auth-overlay.open ~ #dashboardPage{
      filter: blur(18px) saturate(.75);
      transform: scale(.985);
      opacity: .55;
      pointer-events: none;
    }

    .auth-shell{
      width: min(1040px, 100%);
      border-radius: 28px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      box-shadow: 0 30px 120px rgba(0,0,0,.48);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    /* Left brand */
    .auth-brand{
      padding: 30px;
      background:
        radial-gradient(800px circle at 10% 20%, rgba(15,111,166,.40), transparent 55%),
        radial-gradient(900px circle at 80% 70%, rgba(6,68,105,.55), transparent 62%),
        linear-gradient(135deg, rgba(6,68,105,.95) 0%, rgba(5,50,78,.95) 45%, rgba(3,36,58,.95) 100%);
      color: #fff;
      display:flex; flex-direction:column; justify-content:space-between;
      position: relative;
      overflow: hidden;
    }
    .auth-brand::after{
      content:"";
      position:absolute;
      inset:-60% -40%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(15,111,166,.18), transparent 62%);
      transform: translate3d(-6%, -8%, 0);
      animation: casBrandLight 10s ease-in-out infinite;
      pointer-events:none;
      opacity: .95;
    }
    @keyframes casBrandLight{
      0%,100% { transform: translate3d(-6%, -8%, 0); }
      50% { transform: translate3d(6%, 4%, 0); }
    }

    .auth-logo{
      width: 240px; max-width: 100%;
      height: auto;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.25));
      position: relative;
      z-index: 1;
    }
    .auth-brand h2{
      font-size: 24px;
      font-weight: 900;
      margin-top: 16px;
      letter-spacing: .01em;
      position: relative;
      z-index: 1;
    }
    .auth-brand p{
      margin-top: 10px;
      opacity: .94;
      font-weight: 700;
      line-height: 1.65;
      font-size: 13px;
      max-width: 380px;
      position: relative;
      z-index: 1;
    }

    /* New “How it works” block (replaces the 3 small boxes) */
    .auth-how{
      margin-top: 18px;
      border-radius: 18px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      padding: 14px;
      position: relative;
      z-index: 1;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
    }
    .auth-how-top{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .auth-how-title{
      font-weight: 900;
      letter-spacing: .10em;
      font-size: 12px;
      text-transform: uppercase;
      opacity: .92;
    }
    .auth-how-pill{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      opacity: .95;
      white-space: nowrap;
    }
    .auth-steps{
      display:grid;
      gap: 10px;
    }
    .auth-step{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
    }
    .auth-step-num{
      width: 34px; height: 34px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      flex-shrink: 0;
    }
    .auth-step b{ display:block; font-size: 13px; }
    .auth-step span{ display:block; font-size: 12px; opacity: .92; font-weight: 700; margin-top: 2px; line-height: 1.45; }

    .auth-chips{
      margin-top: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .auth-chip{
      font-size: 12px;
      font-weight: 900;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      opacity: .95;
    }

    .auth-brand-footer{
      opacity:.92;
      font-weight:800;
      font-size:12px;
      position: relative;
      z-index: 1;
    }

    /* Right card (NOT plain white) */
    .auth-card{
      background:
        radial-gradient(1200px circle at 18% 8%, rgba(15,111,166,.30), transparent 58%),
        radial-gradient(900px circle at 92% 22%, rgba(6,68,105,.26), transparent 62%),
        radial-gradient(1000px circle at 55% 115%, rgba(10,90,135,.18), transparent 62%),
        linear-gradient(135deg, rgba(234,243,251,.88) 0%, rgba(215,235,251,.82) 40%, rgba(234,243,251,.74) 100%);
      background-size: 140% 140%;
      animation: authCardShift 14s ease-in-out infinite;

      padding: 22px;
      display:flex;
      flex-direction:column;
      gap: 14px;

      position: relative;
      overflow: hidden;
      border-left: 1px solid rgba(9, 61, 94, .12);

      box-shadow: 0 22px 60px rgba(3, 38, 60, .16);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .auth-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 18%, rgba(255,255,255,.38), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,.22), transparent 60%),
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.10) 0px,
          rgba(255,255,255,.10) 1px,
          transparent 1px,
          transparent 10px
        );
      opacity: .22;
      mix-blend-mode: overlay;
      pointer-events:none;
    }
    .auth-card::after{
      content:"";
      position:absolute;
      inset:-60% -30%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.30), transparent 58%),
        radial-gradient(circle at 70% 60%, rgba(15,111,166,.12), transparent 60%);
      transform: translate3d(-8%, -10%, 0);
      animation: casCardLight 10s ease-in-out infinite;
      pointer-events:none;
      opacity: .95;
    }
    @keyframes casCardLight{
      0%,100% { transform: translate3d(-8%, -10%, 0); }
      50%     { transform: translate3d(8%,  6%, 0); }
    }
    @keyframes authCardShift{
      0%,100% { background-position: 0% 0%; }
      50%     { background-position: 100% 60%; }
    }

    .auth-card-head{
      display:flex; align-items:center; justify-content:space-between;
      position: relative;
      z-index: 1;
    }
    .auth-title{
      display:flex; flex-direction:column;
      line-height: 1.2;
    }
    .auth-title h3{ font-size: 16px; font-weight: 900; }
    .auth-title p{ font-size: 12px; color: rgba(13,23,38,.62); font-weight: 800; margin-top: 4px; }

    .tabs{
      display:flex;
      border: 1px solid rgba(6,68,105,.14);
      background: rgba(238,244,250,.92);
      padding: 6px;
      border-radius: 16px;
      gap: 6px;
      position: relative;
      z-index: 1;
      box-shadow: 0 12px 28px rgba(3,38,60,.10);
    }
    .tab{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 13px;
      background: transparent;
      border: 1px solid transparent;
      color: rgba(13,23,38,.70);
    }
    .tab.active{
      background: rgba(255,255,255,.94);
      border-color: rgba(6,68,105,.12);
      box-shadow: 0 10px 20px rgba(3, 30, 50, .10);
      color: var(--cas-800);
    }

    .auth-error{
      display:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.22);
      color: rgba(122, 20, 20, .95);
      font-weight: 800;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }
    .auth-error.show{ display:block; }

    .auth-actions{
      display:flex; gap: 10px; align-items:center; justify-content:space-between;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }
    .auth-actions a{
      color: var(--cas-700);
      font-weight: 900;
      text-decoration: none;
      font-size: 13px;
    }
    .auth-actions a:hover{ text-decoration: underline; }

    .hidden{ display:none !important; }

    /* Mobile */
    .mobile-menu-btn{ display:none; }
    .mobile-overlay{ display:none; }

    @media (max-width: 1024px){
      .sidebar{ display:none; }
      .mobile-menu-btn{
        display:flex;
        background: rgba(255,255,255,.65);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 14px;
        box-shadow: var(--shadow-soft);
      }
      .mobile-overlay{ display:none; position: fixed; inset:0; z-index: 55; }
      .mobile-overlay.open{ display:block; }
      .mobile-sidebar-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.48); backdrop-filter: blur(6px); }
      .mobile-sidebar{
        position:absolute; left:0; top:0; bottom:0; width: 18rem;
        background: rgba(255,255,255,.80);
        border-right: 1px solid var(--border);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
      .mobile-logout{ padding: 14px; border-top: 1px solid var(--border); }
      .header-brand-wrap{ display:none; }
    }

    @media (max-width: 860px){
      .auth-shell{ grid-template-columns: 1fr; }
      .auth-brand{ display:none; }
      .upload-grid{ grid-template-columns: 1fr; }
      .reanalysis-input-group{ flex-direction: column; }
      .content-area{ padding: 16px; }
      .section-header h1{ font-size: 28px; }
    }

    /* If user prefers reduced motion */
    @media (prefers-reduced-motion: reduce){
      .orb, .auth-brand::after, .auth-card, .auth-card::after, .auth-overlay::before { animation: none !important; }
    }
  </style>
</head>

<body>
  <div class="bg-orbs">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-shell">
      <div class="auth-brand">
        <div>
          <img class="auth-logo"
               src="./assets/cas-logo.png"
               alt="CAS Concepts And Skills"
               onerror="this.style.display='none';" />
          <h2>CAS Educations</h2>
          <p>
            Secure access to Math.AI Analyzer. Upload question papers and answer sheets,
            get structured error analysis, corrected solutions, and personalized practice papers.
          </p>

          <!-- Replaced the 3 small boxes with a cleaner “How it works” block -->
          <div class="auth-how">
            <div class="auth-how-top">
              <div class="auth-how-title">How it works</div>
              <div class="auth-how-pill">Secure • Fast • Organized</div>
            </div>

            <div class="auth-steps">
              <div class="auth-step">
                <div class="auth-step-num">1</div>
                <div>
                  <b>Upload</b>
                  <span>Question papers + answer sheets (PDF / images).</span>
                </div>
              </div>

              <div class="auth-step">
                <div class="auth-step-num">2</div>
                <div>
                  <b>Review</b>
                  <span>Error analysis, corrected solutions, and feedback.</span>
                </div>
              </div>

              <div class="auth-step">
                <div class="auth-step-num">3</div>
                <div>
                  <b>Practice</b>
                  <span>Generate a personalized practice paper instantly.</span>
                </div>
              </div>
            </div>

            <div class="auth-chips">
              <div class="auth-chip">JWT Session</div>
              <div class="auth-chip">Math Notation</div>
              <div class="auth-chip">PDF Export</div>
              <div class="auth-chip">History Tracking</div>
            </div>
          </div>
        </div>

        <div class="auth-brand-footer">
          © <span id="yearNow"></span> CAS Educations • Concepts And Skills
        </div>
      </div>

      <div class="auth-card">
        <div class="auth-card-head">
          <div class="auth-title">
            <h3>Math.AI Analyzer</h3>
            <p>Login or create an account</p>
          </div>
          <div class="brand-mark" title="CAS">CAS</div>
        </div>

        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button" onclick="switchAuth('login')">Login</button>
          <button id="tabRegister" class="tab" type="button" onclick="switchAuth('register')">Register</button>
        </div>

        <div id="authError" class="auth-error"></div>

        <!-- LOGIN -->
        <form id="loginForm" onsubmit="handleLogin(event)" style="position:relative; z-index:1;">
          <div style="margin-top: 4px;">
            <label>Username or Email</label>
            <input id="loginIdentifier" type="text" placeholder="e.g. basith / basith@gmail.com" autocomplete="username" />
          </div>

          <div style="margin-top: 12px;">
            <label>Password</label>
            <input id="loginPassword" type="password" placeholder="Enter password" autocomplete="current-password" />
          </div>

          <div style="margin-top: 14px;">
            <button id="loginBtn" class="btn btn-primary" style="width:100%;" type="submit">
              Login
            </button>
          </div>

          <div class="auth-actions">
            <span class="helper">No account?</span>
            <a href="#" onclick="switchAuth('register'); return false;">Register</a>
          </div>
        </form>

        <!-- REGISTER -->
        <form id="registerForm" class="hidden" onsubmit="handleRegister(event)" style="position:relative; z-index:1;">
          <div style="margin-top: 4px;">
            <label>Username</label>
            <input id="regUsername" type="text" placeholder="e.g. basith" autocomplete="username" />
          </div>

          <div style="margin-top: 12px;">
            <label>Email</label>
            <input id="regEmail" type="email" placeholder="e.g. basith@gmail.com" autocomplete="email" />
          </div>

          <div style="margin-top: 12px;">
            <label>Password</label>
            <input id="regPassword" type="password" placeholder="Min 6 characters" autocomplete="new-password" />
          </div>

          <div style="margin-top: 14px;">
            <button id="registerBtn" class="btn btn-primary" style="width:100%;" type="submit">
              Register
            </button>
          </div>

          <div class="auth-actions">
            <span class="helper">Already registered?</span>
            <a href="#" onclick="switchAuth('login'); return false;">Login</a>
          </div>
        </form>

        <div class="helper" style="margin-top: 2px; position:relative; z-index:1;">
          Tip: For best results, run the site via <b>http://localhost:3000</b> (Node server), not Live Server.
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="dashboardPage" class="dashboard-container">
    <div class="dashboard-layout">

      <!-- Sidebar (Desktop) -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="brand-lockup" onclick="resetToDashboard()">
            <div class="brand-mark">CAS</div>
            <div class="brand-texts">
              <div class="brand-title">Math.AI Analyzer</div>
              <div class="brand-subtitle">CAS Educations</div>
            </div>
          </div>
        </div>

        <div class="sidebar-content">
          <div class="sidebar-section-title">Analysis History</div>
          <div id="historyList"></div>
        </div>
      </aside>

      <!-- Mobile Overlay -->
      <div id="mobileOverlay" class="mobile-overlay">
        <div class="mobile-sidebar-backdrop" onclick="closeMobileMenu()"></div>
        <aside class="mobile-sidebar">
          <div class="sidebar-header">
            <div class="brand-lockup" onclick="resetToDashboard(); closeMobileMenu();">
              <div class="brand-mark">CAS</div>
              <div class="brand-texts">
                <div class="brand-title">Math.AI Analyzer</div>
                <div class="brand-subtitle">CAS Educations</div>
              </div>
            </div>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-section-title">Analysis History</div>
            <div id="mobileHistoryList"></div>
          </div>
          <div class="mobile-logout">
            <button class="btn btn-ghost" style="width:100%; justify-content:flex-start;" onclick="handleLogout()">
              <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
              </svg>
              Logout
            </button>
          </div>
        </aside>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <header class="header">
          <div class="header-left">
            <button class="mobile-menu-btn" onclick="openMobileMenu()">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>

            <div class="header-logo" onclick="resetToDashboard()">
              <img class="cas-logo"
                   src="./assets/cas-logo.png"
                   alt="CAS Concepts And Skills"
                   onerror="this.style.display='none';" />
              <div class="header-brand-wrap">
                <span class="header-brand">CAS Educations</span>
                <span class="header-brand-sub">Math.AI Analyzer</span>
              </div>
            </div>
          </div>

          <div class="header-right">
            <p class="user-info">Welcome, <span class="user-name" id="userName">—</span></p>
            <button class="btn btn-ghost" onclick="handleLogout()">
              <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
              </svg>
              Logout
            </button>
          </div>
        </header>

        <main class="content-area">
          <!-- Upload Section -->
          <div id="uploadSection" class="upload-section">
            <div class="section-header">
              <h1>Upload Answer Sheets for Analysis</h1>
              <p>Upload question papers and student answer sheets to get AI-powered analysis.</p>
            </div>

            <div class="upload-grid">
              <div class="upload-card" onclick="document.getElementById('questionInput').click()">
                <div class="upload-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3>Question Papers</h3>
                <p>Upload the original question papers (images or PDF).</p>

                <input type="file" id="questionInput" multiple accept="image/*,.pdf" style="display:none;">
                <button class="btn btn-outline" type="button">
                  <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                  Upload Files
                </button>

                <div id="questionFileList" class="file-list"></div>
              </div>

              <div class="upload-card" onclick="document.getElementById('answerInput').click()">
                <div class="upload-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </div>
                <h3>Student Answer Sheets</h3>
                <p>Upload student’s handwritten answers (images or PDF).</p>

                <input type="file" id="answerInput" multiple accept="image/*,.pdf" style="display:none;">
                <button class="btn btn-outline" type="button">
                  <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                  Upload Files
                </button>

                <div id="answerFileList" class="file-list"></div>
              </div>
            </div>

            <div style="display:flex; justify-content:center;">
              <button id="startAnalysisBtn" class="btn btn-primary btn-start" onclick="startAnalysis()" disabled>
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Start Analysis
              </button>
            </div>
          </div>

          <!-- Results Section -->
          <div id="resultsSection" class="results-section hidden">
            <div class="results-header">
              <div>
                <h1>Analysis Results</h1>
                <p>AI-powered answer sheet analysis</p>
              </div>
              <div class="badge-group" id="badgeGroup"></div>
            </div>

            <div class="accordion" id="accordion"></div>

            <div class="practice-paper-card" id="practicePaperCard">
              <h3>Generate Personalized Practice Paper</h3>
              <p>Create a new question paper with modified questions for incorrect and partial answers.</p>
              <div id="practicePaperContent">
                <button class="btn btn-primary btn-start" onclick="generatePracticePaper()">
                  <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Generate New Question Paper
                </button>
              </div>
            </div>
          </div>

        </main>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Answer Sheet - Question</h3>
        <button class="btn btn-ghost" onclick="closeImageModal()">Close</button>
      </div>
      <div class="modal-body">
        <div class="modal-image">
          <img id="modalImage" src="" alt="Answer sheet">
          <div id="errorHighlight" class="error-highlight" style="display: none;"></div>
        </div>
        <p class="modal-caption" id="modalCaption"></p>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // AUTH (Login/Register/JWT)
    // =========================

    // If you run index from Live Server :5500, set:
    // const API_BASE = "http://localhost:3000";
    const API_BASE = "";

    const AUTH_TOKEN_KEY = "auth_token";
    const AUTH_USER_KEY = "auth_user";

    // DUMMY LOGIN ONLY MODE
    const DUMMY_MODE = true;

    document.getElementById("yearNow").textContent = new Date().getFullYear();

    function showAuthError(msg){
      const el = document.getElementById("authError");
      el.textContent = msg || "Something went wrong.";
      el.classList.add("show");
    }
    function clearAuthError(){
      const el = document.getElementById("authError");
      el.textContent = "";
      el.classList.remove("show");
    }

    function switchAuth(mode){
      clearAuthError();

      // Demo: disable register flow
      if(DUMMY_MODE && mode === "register"){
        showAuthError("Register is disabled in this demo. Use Login (any username/email + any password).");
        return;
      }

      const tabLogin = document.getElementById("tabLogin");
      const tabRegister = document.getElementById("tabRegister");
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");

      if(mode === "register"){
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      } else {
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      }
    }

    function setSession(token, user){
      localStorage.setItem(AUTH_TOKEN_KEY, token);
      localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user));
      document.getElementById("userName").textContent = user?.username || user?.email || "User";
      closeAuthOverlay();
    }

    function clearSession(){
      localStorage.removeItem(AUTH_TOKEN_KEY);
      localStorage.removeItem(AUTH_USER_KEY);
      document.getElementById("userName").textContent = "—";
    }

    function openAuthOverlay(){
      document.getElementById("authOverlay").classList.add("open");
      document.body.style.overflow = "hidden";
    }
    function closeAuthOverlay(){
      document.getElementById("authOverlay").classList.remove("open");
      document.body.style.overflow = "hidden"; // keep locked to app; app has its own scroll
    }

    /*
    async function api(path, options = {}){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        options.headers || {}
      );
      if(token) headers.Authorization = "Bearer " + token;

      const res = await fetch(API_BASE + path, { ...options, headers });
      const data = await res.json().catch(() => ({}));
      if(!res.ok) {
        const msg = data?.message || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return data;
    }
    */

    async function handleLogin(e){
      e.preventDefault();
      clearAuthError();

      const identifier = document.getElementById("loginIdentifier").value.trim();
      const password = document.getElementById("loginPassword").value;

      if(!identifier || !password){
        showAuthError("Please enter your username/email and password.");
        return;
      }

      const btn = document.getElementById("loginBtn");
      const old = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Logging in...';

      try{
        // Dummy login: accept any username/email + any password
        const user = {
          username: identifier.includes("@") ? identifier.split("@")[0] : identifier,
          email: identifier.includes("@") ? identifier : ""
        };
        const token = "demo_" + btoa(identifier + ":" + Date.now());
        setSession(token, user);
      }catch(err){
        showAuthError(err.message);
      }finally{
        btn.disabled = false;
        btn.innerHTML = old;
      }
    }

    async function handleRegister(e){
      e.preventDefault();
      clearAuthError();

      // Dummy mode: register disabled
      showAuthError("Register is disabled in this demo. Use Login (any username/email + any password).");
      return;

      /*
      const username = document.getElementById("regUsername").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      if(!username || !email || !password){
        showAuthError("Please fill username, email and password.");
        return;
      }
      if(password.length < 6){
        showAuthError("Password must be at least 6 characters.");
        return;
      }

      const btn = document.getElementById("registerBtn");
      const old = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Creating...';

      try{
        const data = await api("/api/auth/register", {
          method: "POST",
          body: JSON.stringify({ username, email, password })
        });
        setSession(data.token, data.user);
      }catch(err){
        showAuthError(err.message);
      }finally{
        btn.disabled = false;
        btn.innerHTML = old;
      }
      */
    }

    async function bootstrapAuth(){
      // Demo: restore from localStorage only (no backend verification)
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(!token){
        openAuthOverlay();
        return;
      }
      try{
        const stored = localStorage.getItem(AUTH_USER_KEY);
        const user = stored ? JSON.parse(stored) : null;
        document.getElementById("userName").textContent = user?.username || user?.email || "User";
        closeAuthOverlay();
      }catch(e){
        clearSession();
        openAuthOverlay();
      }
    }

    function handleLogout(){
      clearSession();
      resetToDashboard();
      openAuthOverlay();
    }

    // Disable the Register tab button in demo mode (UI only; link still shows message)
    if(DUMMY_MODE){
      const tabRegister = document.getElementById("tabRegister");
      if(tabRegister){
        tabRegister.disabled = true;
        tabRegister.style.opacity = ".6";
        tabRegister.style.cursor = "not-allowed";
      }
    }

    // =========================
    // Existing app logic below
    // =========================

    /*
    let questionFiles = [];
    let answerFiles = [];
    let allFiles = [];
    let analysisResult = null;
    let practiceResult = null;
    let history = [];
    let isAnalyzing = false;

    function renderMath(element) {
      if (window.MathJax) {
        MathJax.typesetPromise([element]).catch(err => console.error("MathJax error:", err));
      }
    }

    // Mobile menu
    function openMobileMenu(){ document.getElementById("mobileOverlay").classList.add("open"); }
    function closeMobileMenu(){ document.getElementById("mobileOverlay").classList.remove("open"); }

    function resetToDashboard(){
      document.getElementById("uploadSection").classList.remove("hidden");
      document.getElementById("resultsSection").classList.add("hidden");
      closeMobileMenu();
    }

    // File handling
    document.getElementById("questionInput").addEventListener("change", async (e) => {
      await handleFileUpload(e.target.files, questionFiles, "questionFileList");
      checkStartButton();
    });

    document.getElementById("answerInput").addEventListener("change", async (e) => {
      await handleFileUpload(e.target.files, answerFiles, "answerFileList");
      checkStartButton();
    });

    async function handleFileUpload(files, targetArray, listId) {
      for (let file of files) {
        if (!targetArray.find(f => f.name === file.name)) {
          let dataURL = "";
          if (file.type.startsWith("image/")) {
            dataURL = await new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = ev => resolve(ev.target.result);
              reader.readAsDataURL(file);
            });
          }
          targetArray.push({ name: file.name, file: file, dataURL: dataURL });
        }
      }
      displayFiles(listId, targetArray);
    }

    function displayFiles(elementId, files) {
      const el = document.getElementById(elementId);
      el.innerHTML = files.map(f => `
        <div class="file-item">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          ${f.name}
        </div>
      `).join("");
    }

    function checkStartButton() {
      document.getElementById("startAnalysisBtn").disabled = questionFiles.length === 0 || answerFiles.length === 0;
    }

    async function startAnalysis() {
      if (isAnalyzing) return;
      isAnalyzing = true;

      const btn = document.getElementById("startAnalysisBtn");
      const old = btn.innerHTML;

      btn.innerHTML = '<span class="loading"></span> Analyzing...';
      btn.disabled = true;

      const formData = new FormData();
      allFiles = [...questionFiles, ...answerFiles];
      allFiles.forEach(f => formData.append("files", f.file));

      try {
        const res = await fetch("https://navalsheth.pythonanywhere.com/analyze", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (data.error) alert(data.error);
        else {
          analysisResult = data;

          // Attach local preview DataURLs to questions if possible (optional)
          // This helps your "View Answer Image" work even if backend doesn't return image URLs.
          if (analysisResult?.questions?.length) {
            const answerImages = answerFiles.filter(x => x.dataURL);
            analysisResult.questions.forEach((q, idx) => {
              q.dataURL = answerImages[idx]?.dataURL || q.dataURL || "";
            });
          }

          displayAnalysis(data);
          addToHistory();
          document.getElementById("uploadSection").classList.add("hidden");
          document.getElementById("resultsSection").classList.remove("hidden");
        }
      } catch (e) {
        alert("Error: " + e.message);
      } finally {
        isAnalyzing = false;
        btn.innerHTML = old;
        btn.disabled = false;
      }
    }

    function processSteps(str) {
      if (!str) return "";
      const steps = str.split("<br>").filter(step => step.trim() !== "");
      return steps.map(step => `<p>${step.trim()}</p>`).join("");
    }

    function displayAnalysis(result) {
      const accordion = document.getElementById("accordion");
      accordion.innerHTML = "";
      let counts = { correct: 0, partial: 0, incorrect: 0 };

      result.questions.forEach((q, i) => {
        counts[q.status]++;

        const item = document.createElement("div");
        item.className = "accordion-item";
        item.innerHTML = `
          <button class="accordion-trigger" onclick="toggleAccordion('q${i}')">
            <div class="question-number ${q.status}">${q.number}</div>
            <div class="question-info">
              <p>${q.question}</p>
              <p>Status: ${q.status}</p>
            </div>
          </button>

          <div id="q${i}" class="accordion-content">
            <div class="analysis-section">
              <h3>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Student Solution
              </h3>
              <div class="solution-card"><div class="solution-steps">${processSteps(q.student_original)}</div></div>
            </div>

            <div class="analysis-section">
              <h3>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Error Analysis
              </h3>
              <div class="solution-card error"><p style="font-weight:800; color: rgba(13,23,38,.82);">${q.error}</p></div>
            </div>

            <div class="analysis-section">
              <h3>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                LLM-Corrected Solution
              </h3>
              <div class="solution-card corrected"><div class="solution-steps">${processSteps(q.correct_solution)}</div></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;">
              <button class="btn btn-outline" onclick="openImageModal(${i}, '${q.status}', ${JSON.stringify(q.error_bbox || {})})">
                View Answer Image
              </button>
            </div>

            <div class="reanalysis-card">
              <h3 style="font-size:14px; font-weight:900; margin-bottom: 10px;">Re-analyze This Question</h3>
              <div class="reanalysis-input-group">
                <input type="text" id="reanalysisInput${i}" placeholder="Ask AI to re-analyze this question..." />
                <button class="btn btn-primary" style="width:auto;" onclick="reanalyzeQuestion(${i})">Send</button>
              </div>
              <div id="aiResponse${i}" style="display:none;" class="ai-response">
                <div class="ai-badge">AI</div>
                <p></p>
              </div>
            </div>
          </div>
        `;
        accordion.appendChild(item);
        renderMath(item);
      });

      document.getElementById("badgeGroup").innerHTML = `
        <div class="badge"><div class="badge-dot correct"></div>${counts.correct} Correct</div>
        <div class="badge"><div class="badge-dot partial"></div>${counts.partial} Partial</div>
        <div class="badge"><div class="badge-dot incorrect"></div>${counts.incorrect} Incorrect</div>
      `;
    }

    function toggleAccordion(id) {
      document.getElementById(id).classList.toggle("open");
    }

    async function reanalyzeQuestion(i) {
      const query = document.getElementById(`reanalysisInput${i}`).value.trim();
      if (!query) return;

      const question = analysisResult.questions[i];
      const btn = event.target;
      const old = btn.innerHTML;
      btn.innerHTML = '<span class="loading"></span>';
      btn.disabled = true;

      try {
        const res = await fetch("https://navalsheth.pythonanywhere.com/reanalyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_query: query,
            question: question.question,
            student_original: question.student_original,
            error: question.error,
            correct_solution: question.correct_solution
          })
        });

        const data = await res.json();
        if (data.error) alert(data.error);
        else {
          const responseDiv = document.getElementById(`aiResponse${i}`);
          responseDiv.style.display = "flex";
          responseDiv.querySelector("p").innerHTML = data.response;
          renderMath(responseDiv);
        }
      } catch (e) {
        alert("Error: " + e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = old;
      }
    }

    function openImageModal(i, status, bbox) {
      const modal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");
      const modalTitle = document.getElementById("modalTitle");
      const errorHighlight = document.getElementById("errorHighlight");
      const modalCaption = document.getElementById("modalCaption");

      modalTitle.textContent = `Answer Sheet - Question ${analysisResult.questions[i].number}`;
      modalImage.src = analysisResult.questions[i].dataURL || "";
      modalCaption.textContent = `Status: ${status}`;

      if (bbox && bbox.x && bbox.y && bbox.width && bbox.height) {
        errorHighlight.style.display = "block";
        errorHighlight.style.left = `${bbox.x}px`;
        errorHighlight.style.top = `${bbox.y}px`;
        errorHighlight.style.width = `${bbox.width}px`;
        errorHighlight.style.height = `${bbox.height}px`;
      } else {
        errorHighlight.style.display = "none";
      }

      modal.classList.add("open");
    }

    function closeImageModal() {
      document.getElementById("imageModal").classList.remove("open");
    }

    async function generatePracticePaper() {
      if (!analysisResult) return;
      const content = document.getElementById("practicePaperContent");
      content.innerHTML = '<span class="loading"></span> Generating...';

      try {
        const res = await fetch("https://navalsheth.pythonanywhere.com/generate_practice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ analysis: analysisResult })
        });

        const data = await res.json();
        if (data.error) {
          content.innerHTML = `<p style="font-weight:800;">Error: ${data.error}</p>`;
        } else if (data.practice_questions.length === 0) {
          content.innerHTML = '<p style="font-weight:800;">No mistakes found, no practice needed!</p>';
        } else {
          practiceResult = data;
          content.innerHTML = `
            <div class="practice-paper" id="practice-paper">
              <div class="practice-header">
                <div class="practice-title">📝 Practice Paper</div>
                <div class="practice-subtitle">Practice questions based on areas needing improvement</div>
              </div>
              <div class="practice-questions">
                ${data.practice_questions.map(pq => `
                  <div class="practice-question">
                    <div class="practice-question-number">Question ${pq.number}</div>
                    <div class="practice-question-text">${pq.question}</div>
                  </div>
                `).join("")}
              </div>
              <div style="text-align:center; margin-top: 18px;">
                <button class="btn btn-outline" onclick="downloadPracticePaper()">Download as PDF</button>
              </div>
            </div>
          `;
          renderMath(document.getElementById("practice-paper"));
        }
      } catch (e) {
        content.innerHTML = `<p style="font-weight:800;">Error: ${e.message}</p>`;
      }
    }

    async function downloadPracticePaper() {
      if (!practiceResult) return;
      const practicePaper = document.getElementById("practice-paper");
      if (!practicePaper) {
        alert("Practice paper not found!");
        return;
      }

      const loading = document.createElement("div");
      loading.innerHTML = '<div class="panel" style="padding:14px 16px; display:flex; gap:10px; align-items:center;"><span class="loading" style="border-color: rgba(6,68,105,.20); border-top-color: var(--cas-800);"></span><b style="font-weight:900;">Generating PDF...</b></div>';
      Object.assign(loading.style, {
        position: "fixed",
        top: "50%",
        left: "50%",
        transform: "translate(-50%, -50%)",
        zIndex: "9999"
      });
      document.body.appendChild(loading);

      try {
        await new Promise(resolve => setTimeout(resolve, 600));

        const canvas = await html2canvas(practicePaper, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff",
          logging: false,
          windowWidth: practicePaper.scrollWidth + 60,
          windowHeight: practicePaper.scrollHeight + 60,
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = pdf.internal.pageSize.getWidth();
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        pdf.save(`Math_Practice_Paper_${new Date().toISOString().slice(0, 10)}.pdf`);
      } catch (error) {
        console.error("PDF generation failed:", error);
        alert("Failed to generate PDF. Please try again.");
      } finally {
        document.body.removeChild(loading);
      }
    }

    function addToHistory() {
      const title = `Analysis - ${new Date().toLocaleDateString()}`;
      history.push({ title, date: new Date().toLocaleDateString() });
      updateHistory();
    }

    function updateHistory() {
      const html = history.map(h => `
        <div class="sidebar-item">
          <div class="sidebar-item-title">${h.title}</div>
          <div class="sidebar-item-date">${h.date}</div>
        </div>
      `).join("");
      document.getElementById("historyList").innerHTML = html;
      document.getElementById("mobileHistoryList").innerHTML = html;
    }
    */

    // =========================
    // Minimal stubs (so UI doesn't error in dummy-login demo)
    // =========================
    function openMobileMenu(){ document.getElementById("mobileOverlay").classList.add("open"); }
    function closeMobileMenu(){ document.getElementById("mobileOverlay").classList.remove("open"); }
    function resetToDashboard(){
      document.getElementById("uploadSection").classList.remove("hidden");
      document.getElementById("resultsSection").classList.add("hidden");
      closeMobileMenu();
    }
    function startAnalysis(){ alert("Analysis logic is disabled in this dummy-login demo."); }
    function generatePracticePaper(){ alert("Practice paper generation is disabled in this dummy-login demo."); }
    function downloadPracticePaper(){ alert("PDF export is disabled in this dummy-login demo."); }
    function toggleAccordion(){ /* no-op in demo */ }
    function reanalyzeQuestion(){ alert("Re-analyze is disabled in this dummy-login demo."); }
    function openImageModal(){ alert("Image modal is disabled in this dummy-login demo."); }
    function closeImageModal(){ document.getElementById("imageModal").classList.remove("open"); }

    // Start auth bootstrap on load
    bootstrapAuth();
  </script>

  <!-- UI updates only: background + auth panel polish. -->
</body>
</html>
