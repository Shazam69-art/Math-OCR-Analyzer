<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math.AI Analyzer - C-A-S educations</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],
                displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => { return MathJax.startup.defaultPageReady(); }
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f8faff;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --primary: #4361ee;
            --primary-light: #e0e7ff;
            --border: #e2e8f0;
            --sidebar-bg: #f1f5f9;
            --sidebar-border: #e2e8f0;
            --radius: 1rem;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #f8faff 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        /* Login Screen */
        #loginPage {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .login-header {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--text);
            letter-spacing: -0.5px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: var(--radius);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow);
        }
        .login-card h2 {
            font-size: 1.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 0.25rem);
            font-size: 1rem;
            background: white;
            transition: border 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.875rem;
            border-radius: calc(var(--radius) - 0.25rem);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .social-btn.google {
            background: #ffffff;
            border: 1px solid var(--border);
        }
        .social-btn.google:hover { background: #f8f9fa; }
        .social-btn.apple {
            background: #000000;
            color: white;
        }
        .social-btn.apple:hover { background: #1a1a1a; }
        .social-btn img {
            width: 20px;
            height: 20px;
        }
        /* Dashboard */
        #dashboardPage {
            display: none;
            height: 100vh;
            width: 100%;
        }
        .dashboard-container {
            display: flex;
            height: 100vh;
            width: 100%;
            background: var(--bg);
        }
        .sidebar {
            width: 17rem;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--sidebar-border);
        }
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-size: 1.375rem;
            font-weight: 700;
            cursor: pointer;
        }
        .sidebar-logo-icon {
            width: 2.75rem;
            height: 2.75rem;
            background: var(--primary);
            border-radius: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .sidebar-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .sidebar-section-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }
        .sidebar-item {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar-item:hover {
            background: var(--primary-light);
        }
        .sidebar-item-title {
            font-weight: 500;
        }
        .sidebar-item-date {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .header-brand {
            font-weight: 700;
            font-size: 1.25rem;
        }
        .user-info {
            font-weight: 500;
            color: var(--text-muted);
        }
        .user-name {
            color: var(--primary);
            font-weight: 600;
        }
        .btn-logout {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }
        .btn-logout:hover {
            background: var(--primary-light);
        }
        .content-area {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
        }
        .section-header {
            text-align: center;
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .section-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        .section-header p {
            font-size: 1.125rem;
            color: var(--text-muted);
        }
        .upload-grid {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 3rem;
        }
        .upload-card {
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            width: 100%;
            max-width: 22rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }
        .upload-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
        }
        .upload-icon {
            width: 5rem;
            height: 5rem;
            background: var(--primary-light);
            border-radius: 1.25rem;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        .btn-start {
            background: var(--primary);
            color: white;
            padding: 1rem 3rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0 auto;
            transition: all 0.2s;
        }
        .btn-start:hover { opacity: 0.9; }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; }
        .results-section { max-width: 960px; margin: 0 auto; }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .badge-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            background: var(--primary-light);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .badge-dot {
            width: 0.625rem;
            height: 0.625rem;
            border-radius: 50%;
        }
        .badge-dot.correct { background: #22c55e; }
        .badge-dot.partial { background: #eab308; }
        .badge-dot.incorrect { background: #ef4444; }
        .accordion-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .accordion-trigger {
            width: 100%;
            padding: 1.5rem;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .accordion-trigger:hover { background: var(--primary-light); }
        .question-number {
            width: 3rem;
            height: 3rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            flex-shrink: 0;
        }
        .question-number.correct { background: rgba(34,197,94,0.1); color: #16a34a; }
        .question-number.partial { background: rgba(234,179,8,0.1); color: #ca8a04; }
        .question-number.incorrect { background: rgba(239,68,68,0.1); color: #dc2626; }
        .accordion-content {
            padding: 0 1.5rem 1.5rem;
            display: none;
        }
        .accordion-content.open { display: block; }
        .analysis-section h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1.5rem 0 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
        }
        .solution-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 0.875rem;
            padding: 1.25rem;
        }
        .solution-card.error { background: rgba(239,68,68,0.05); }
        .solution-card.corrected { background: rgba(34,197,94,0.05); }
        .practice-paper-card {
            background: var(--card-bg);
            border: 2px solid var(--primary-light);
            border-radius: var(--radius);
            padding: 2rem;
            margin-top: 3rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .practice-paper {
            padding: 40px;
            background: white;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
        }
        .practice-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .practice-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .practice-subtitle {
            font-size: 18px;
            color: #666;
        }
        .practice-question {
            margin-bottom: 40px;
        }
        .practice-question-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        @media (max-width: 1024px) {
            .sidebar { display: none; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <h1 class="login-header">C-A-S educations</h1>
        <div class="login-card">
            <h2>Academy Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username / Email</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="btn-start" style="width:100%; margin-top:1rem;">
                    Sign In
                </button>
            </form>
            <div class="social-buttons">
                <button class="social-btn google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Continue with Google
                </button>
                <button class="social-btn apple">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple">
                    Continue with Apple
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo" onclick="resetToDashboard()">
                    <div class="sidebar-logo-icon">M</div>
                    <div>Math.AI Analyzer</div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section-title">Analysis History</div>
                <div id="historyList"></div>
            </div>
        </aside>
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <div class="header-brand">C-A-S educations</div>
                </div>
                <div style="display:flex; align-items:center; gap:1.5rem;">
                    <p class="user-info">Welcome, <span class="user-name" id="userName">User</span></p>
                    <button class="btn-logout" onclick="handleLogout()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Logout
                    </button>
                </div>
            </header>
            <main class="content-area">
                <div id="uploadSection" class="upload-section">
                    <div class="section-header">
                        <h1>Upload Answer Sheets for Analysis</h1>
                        <p>Upload question papers and student answer sheets to get AI-powered analysis</p>
                    </div>
                    <div class="upload-grid">
                        <div class="upload-card" onclick="document.getElementById('questionInput').click()">
                            <div class="upload-icon">
                                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3>Question Papers</h3>
                            <p>Upload the original question papers</p>
                            <input type="file" id="questionInput" multiple accept="image/*,.pdf" style="display:none;">
                            <div id="questionFileList" class="file-list" style="margin-top:1rem;"></div>
                        </div>
                        <div class="upload-card" onclick="document.getElementById('answerInput').click()">
                            <div class="upload-icon">
                                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </div>
                            <h3>Student Answer Sheets</h3>
                            <p>Upload student's handwritten answers</p>
                            <input type="file" id="answerInput" multiple accept="image/*,.pdf" style="display:none;">
                            <div id="answerFileList" class="file-list" style="margin-top:1rem;"></div>
                        </div>
                    </div>
                    <button id="startAnalysisBtn" class="btn-start" onclick="startAnalysis()" disabled>
                        Start Analysis
                    </button>
                </div>

                <div id="resultsSection" class="results-section hidden">
                    <div class="results-header">
                        <div>
                            <h1>Analysis Results</h1>
                            <p>AI-powered answer sheet analysis</p>
                        </div>
                        <div class="badge-group" id="badgeGroup"></div>
                    </div>
                    <div class="accordion" id="accordion"></div>
                    <div class="practice-paper-card" id="practicePaperCard">
                        <h3>Generate Personalized Practice Paper</h3>
                        <p>Create a new question paper with modified questions for incorrect and partial answers</p>
                        <div id="practicePaperContent">
                            <button class="btn-start" onclick="generatePracticePaper()">
                                Generate New Question Paper
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Login handling
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return;

            let displayName = username;
            if (username.includes('@')) {
                displayName = username.split('@')[0];
            }
            displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);

            localStorage.setItem('userEmailPrefix', displayName);
            document.getElementById('userName').textContent = displayName;

            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'flex';
        });

        // Load saved user on refresh
        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('userEmailPrefix');
            if (savedName) {
                document.getElementById('userName').textContent = savedName;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'flex';
            }
        });

        function handleLogout() {
            localStorage.removeItem('userEmailPrefix');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').style.display = 'none';
        }

        // Rest of the original logic (unchanged except PDF fix)
        let questionFiles = [];
        let answerFiles = [];
        let allFiles = [];
        let analysisResult = null;
        let practiceResult = null;
        let history = [];
        let isAnalyzing = false;

        function renderMath(element) {
            if (window.MathJax) {
                MathJax.typesetPromise([element]).catch(err => console.error('MathJax error:', err));
            }
        }

        function resetToDashboard() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        document.getElementById('questionInput').addEventListener('change', async e => {
            await handleFileUpload(e.target.files, questionFiles, 'questionFileList');
            checkStartButton();
        });
        document.getElementById('answerInput').addEventListener('change', async e => {
            await handleFileUpload(e.target.files, answerFiles, 'answerFileList');
            checkStartButton();
        });

        async function handleFileUpload(files, targetArray, listId) {
            for (let file of files) {
                if (!targetArray.find(f => f.name === file.name)) {
                    let dataURL = '';
                    if (file.type.startsWith('image/')) {
                        dataURL = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = ev => resolve(ev.target.result);
                            reader.readAsDataURL(file);
                        });
                    }
                    targetArray.push({name: file.name, file: file, dataURL: dataURL});
                }
            }
            displayFiles(listId, targetArray);
        }

        function displayFiles(elementId, files) {
            const el = document.getElementById(elementId);
            el.innerHTML = files.map(f => `
                <div style="display:flex; align-items:center; gap:0.5rem; color:var(--text-muted); font-size:0.875rem; margin-bottom:0.25rem;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    ${f.name}
                </div>
            `).join('');
        }

        function checkStartButton() {
            document.getElementById('startAnalysisBtn').disabled = questionFiles.length === 0 || answerFiles.length === 0;
        }

        async function startAnalysis() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            const btn = document.getElementById('startAnalysisBtn');
            btn.innerHTML = '<div class="loading"></div> Analyzing...';
            btn.disabled = true;

            const formData = new FormData();
            allFiles = [...questionFiles, ...answerFiles];
            allFiles.forEach(f => formData.append('files', f.file));

            try {
                const res = await fetch('https://navalsheth.pythonanywhere.com/analyze', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.error) alert(data.error);
                else {
                    analysisResult = data;
                    displayAnalysis(data);
                    addToHistory();
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                isAnalyzing = false;
                btn.innerHTML = 'Start Analysis';
                btn.disabled = false;
            }
        }

        function processSteps(str) {
            if (!str) return '';
            const steps = str.split('<br>').filter(step => step.trim() !== '');
            return steps.map(step => `<p style="margin-bottom:0.75rem; line-height:1.8;">${step.trim()}</p>`).join('');
        }

        function displayAnalysis(result) {
            const accordion = document.getElementById('accordion');
            accordion.innerHTML = '';
            let counts = {correct: 0, partial: 0, incorrect: 0};
            result.questions.forEach((q, i) => {
                counts[q.status]++;
                const item = document.createElement('div');
                item.className = 'accordion-item';
                item.innerHTML = `
                    <button class="accordion-trigger" onclick="toggleAccordion('q${i}')">
                        <div class="question-number ${q.status}">${q.number}</div>
                        <div style="text-align:left;">
                            <p style="font-weight:600; margin-bottom:0.25rem;">${q.question}</p>
                            <p style="color:var(--text-muted); font-size:0.875rem;">Status: ${q.status}</p>
                        </div>
                    </button>
                    <div id="q${i}" class="accordion-content">
                        <div class="analysis-section">
                            <h3>Student Solution</h3>
                            <div class="solution-card"><div class="solution-steps">${processSteps(q.student_original)}</div></div>
                        </div>
                        <div class="analysis-section">
                            <h3>Error Analysis</h3>
                            <div class="solution-card error"><p>${q.error}</p></div>
                        </div>
                        <div class="analysis-section">
                            <h3>LLM-Corrected Solution</h3>
                            <div class="solution-card corrected"><div class="solution-steps">${processSteps(q.correct_solution)}</div></div>
                        </div>
                        <button class="btn-start" style="margin-top:1rem;" onclick="openImageModal(${i}, '${q.status}', '${q.image_file || ''}', ${JSON.stringify(q.error_bbox || {})})">
                            View Answer Image
                        </button>
                    </div>`;
                accordion.appendChild(item);
                renderMath(item);
            });
            document.getElementById('badgeGroup').innerHTML = `
                <div class="badge"><div class="badge-dot correct"></div>${counts.correct} Correct</div>
                <div class="badge"><div class="badge-dot partial"></div>${counts.partial} Partial</div>
                <div class="badge"><div class="badge-dot incorrect"></div>${counts.incorrect} Incorrect</div>
            `;
        }

        function toggleAccordion(id) {
            document.getElementById(id).classList.toggle('open');
        }

        async function generatePracticePaper() {
            if (!analysisResult) return;
            const content = document.getElementById('practicePaperContent');
            content.innerHTML = '<div class="loading"></div> Generating...';
            try {
                const res = await fetch('https://navalsheth.pythonanywhere.com/generate_practice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({analysis: analysisResult})
                });
                const data = await res.json();
                if (data.error) {
                    content.innerHTML = `<p>Error: ${data.error}</p>`;
                } else if (data.practice_questions.length === 0) {
                    content.innerHTML = '<p>No mistakes found, no practice needed!</p>';
                } else {
                    practiceResult = data;
                    content.innerHTML = `
                        <div class="practice-paper" id="practice-paper">
                            <div class="practice-header">
                                <div class="practice-title">Practice Paper</div>
                                <div class="practice-subtitle">Practice questions based on areas needing improvement</div>
                            </div>
                            <div class="practice-questions">
                                ${data.practice_questions.map(pq => `
                                    <div class="practice-question">
                                        <div class="practice-question-number">Question ${pq.number}</div>
                                        <div class="practice-question-text">${pq.question}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="text-align:center; margin-top:40px;">
                                <button class="btn-start" onclick="downloadPracticePaper()">Download as PDF</button>
                            </div>
                        </div>`;
                    // Critical fix: Typeset MathJax first, then wait before capturing
                    await MathJax.typesetPromise([document.getElementById('practice-paper')]);
                }
            } catch (e) {
                content.innerHTML = `<p>Error: ${e.message}</p>`;
            }
        }

        async function downloadPracticePaper() {
            if (!practiceResult) return;
            const practicePaper = document.getElementById('practice-paper');
            if (!practicePaper) return;

            const loading = document.createElement('div');
            loading.innerHTML = '<div class="loading"></div> Generating PDF...';
            Object.assign(loading.style, {
                position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
                background: 'rgba(255,255,255,0.95)', padding: '30px', borderRadius: '12px', zIndex: '9999'
            });
            document.body.appendChild(loading);

            try {
                // Ensure MathJax is fully rendered
                await MathJax.typesetPromise([practicePaper]);

                const canvas = await html2canvas(practicePaper, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowWidth: practicePaper.scrollWidth + 100,
                    windowHeight: practicePaper.scrollHeight + 100
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = pdf.internal.pageSize.getWidth();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth - 20, imgHeight - 20);
                pdf.save(`Math_Practice_Paper_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                document.body.removeChild(loading);
            }
        }

        function addToHistory() {
            const title = `Analysis - ${new Date().toLocaleDateString()}`;
            history.push({title, date: new Date().toLocaleDateString()});
            updateHistory();
        }

        function updateHistory() {
            const html = history.map(h => `
                <div class="sidebar-item">
                    <div class="sidebar-item-title">${h.title}</div>
                    <div class="sidebar-item-date">${h.date}</div>
                </div>
            `).join('');
            document.getElementById('historyList').innerHTML = html;
        }
    </script>
</body>
</html>
